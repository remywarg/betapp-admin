<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bildirim Gönder</title>

  <script>
    // Tek yerden API
    window.API_BASE = "https://api.mybetapp.io";

    // admin.mybetapp.io -> app.mybetapp.io (tenant host)
    window.TENANT_HOST = (() => {
      const h = (location.hostname || "").toLowerCase();
      const root = h.replace(/^admin\./, "");
      return "app." + root;
    })();
  </script>

  <meta name="theme-color" content="#0b0b0c" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root{
      --bg:#070708;
      --panel: rgba(25,25,27,.78);
      --panel2: rgba(35,35,38,.72);
      --border: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.58);
      --muted2: rgba(255,255,255,.44);
      --btnBg: rgba(255,255,255,.10);
      --fieldBg: rgba(255,255,255,.08);
      --ok: rgba(99, 220, 155, .85);
      --warn: rgba(255, 210, 120, .9);
      --bad: rgba(255, 120, 120, .92);
      --shadow: 0 28px 90px rgba(0,0,0,.55);
      --radius: 22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    html{ background: var(--bg); overscroll-behavior:none; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display",system-ui,Segoe UI,Roboto,Arial;
      color: var(--text);
      background:
        radial-gradient(900px 560px at 50% 85%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg, #09090a, #000);
    }

    /* Layout (sol menü + içerik) */
    .layout{
      min-height:100vh;
      display:grid;
      grid-template-columns: 280px 1fr;
    }

    aside{
      padding: 18px;
      border-right: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,0));
    }

    .nav{
      margin-top: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .nav a{
      text-decoration:none;
      color: rgba(255,255,255,.86);
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid transparent;
      display:flex;
      align-items:center;
      gap: 10px;
    }

    .nav a.active{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.10);
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
    }

    .logout{
      margin-top: 16px;
      width: 100%;
    }

    main{
      padding: 26px 24px calc(26px + env(safe-area-inset-bottom));
    }

    .title{
      font-size: 28px;
      font-weight: 720;
      margin: 0 0 6px 0;
      letter-spacing: .2px;
    }
    .sub{
      margin: 0 0 18px 0;
      color: var(--muted);
      font-size: 14px;
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 26px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      padding: 18px;
      max-width: 980px;
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .label{
      font-size: 13px;
      color: var(--muted);
      margin: 0 0 8px 0;
    }

    .seg{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .chip{
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      cursor:pointer;
      user-select:none;
      font-size: 13px;
      font-weight: 600;
    }
    .chip.active{
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.16);
    }

    .field{
      width: 100%;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: var(--fieldBg);
      color: var(--text);
      outline: none;
      font-size: 14px;
      font-weight: 520;
    }
    .field::placeholder{ color: var(--muted2); }

    textarea.field{
      min-height: 120px;
      resize: vertical;
    }

    .counter{
      margin-top: 8px;
      color: var(--muted2);
      font-size: 12px;
      text-align:right;
    }

    .actions{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      margin-top: 14px;
      flex-wrap: wrap;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: var(--btnBg);
      color: rgba(255,255,255,.9);
      cursor:pointer;
      font-size: 13px;
      font-weight: 620;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: scale(.98); }

    .btn.primary{
      background: rgba(255,255,255,.14);
      border-color: rgba(255,255,255,.18);
    }

    .status{
      margin-top: 12px;
      font-size: 13px;
      color: var(--muted);
      display:none;
    }
    .status.ok{ color: var(--ok); }
    .status.bad{ color: var(--bad); }
    .status.warn{ color: var(--warn); }
    .status.show{ display:block; }

    /* Modal */
    .modalBack{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modalBack.show{ display:flex; }

    .modal{
      width: 100%;
      max-width: 560px;
      background: rgba(18,18,20,.85);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 22px;
      box-shadow: 0 30px 110px rgba(0,0,0,.65);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      padding: 16px;
    }
    .modal h3{
      margin: 0 0 10px 0;
      font-size: 18px;
      font-weight: 720;
    }
    .kv{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      padding: 12px;
      margin-top: 10px;
    }
    .kv .k{ color: var(--muted2); font-size: 12px; margin-bottom: 6px; }
    .kv .v{ color: rgba(255,255,255,.92); font-size: 14px; font-weight: 600; word-break: break-word; }
    .modalActions{
      margin-top: 14px;
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }

    @media (max-width: 920px){
      .layout{ grid-template-columns: 1fr; }
      aside{ border-right:none; border-bottom: 1px solid rgba(255,255,255,.08); }
    }
  </style>
</head>

<body>
  <div class="layout">
    <aside>
      <div style="font-weight:800;font-size:18px; letter-spacing:.2px;">BetApp Admin</div>
      <div style="color:rgba(255,255,255,.52); font-size:12px; margin-top:6px;">Panel</div>

      <nav class="nav" aria-label="Menü">
        <a href="dashboard.html">Dashboard</a>
        <a class="active" href="send.html">Bildirim Gönder</a>
        <a href="campaigns.html">Kampanyalar</a>
        <a href="users.html">Kullanıcılar</a>
        <a href="profile.html">Profil</a>
      </nav>

      <button class="btn logout" id="btnLogout">Çıkış Yap</button>
    </aside>

    <main>
      <h1 class="title">Bildirim Gönder</h1>
      <p class="sub">Anında · Zamanlı · Test gönderim</p>

      <div class="card">
        <div class="row" style="margin-bottom: 12px;">
          <div style="min-width:220px;">
            <div class="label">Gönderim türü</div>
            <div class="seg">
              <div class="chip active" data-mode="now">Anında</div>
              <div class="chip" data-mode="scheduled">Zamanlı</div>
              <div class="chip" data-mode="test">Test</div>
            </div>
          </div>

          <div id="scheduledWrap" style="min-width:240px; display:none;">
            <div class="label">Tarih / Saat</div>
            <input class="field" id="scheduledAt" type="datetime-local" />
          </div>
        </div>

        <div style="margin-top: 8px;">
          <div class="label">Başlık</div>
          <input class="field" id="title" maxlength="40" placeholder="Kısa başlık" />
          <div class="counter"><span id="cTitle">0</span> / 40</div>
        </div>

        <div style="margin-top: 14px;">
          <div class="label">Mesaj</div>
          <textarea class="field" id="message" maxlength="120" placeholder="Bildirim mesajı"></textarea>
          <div class="counter"><span id="cMsg">0</span> / 120</div>
        </div>

        <div class="actions">
          <button class="btn" id="btnPreview">Önizle</button>
          <button class="btn primary" id="btnSend">Gönder</button>
        </div>

        <div class="status" id="status"></div>
      </div>
    </main>
  </div>

  <!-- Preview Modal -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-label="Önizleme">
    <div class="modal">
      <h3>Bildirim Önizlemesi</h3>

      <div class="kv">
        <div class="k">Tür</div>
        <div class="v" id="pvMode">—</div>
      </div>

      <div class="kv">
        <div class="k">Başlık</div>
        <div class="v" id="pvTitle">—</div>
      </div>

      <div class="kv">
        <div class="k">Mesaj</div>
        <div class="v" id="pvMessage">—</div>
      </div>

      <div class="kv" id="pvTimeWrap" style="display:none;">
        <div class="k">Zaman</div>
        <div class="v" id="pvTime">—</div>
      </div>

      <div class="modalActions">
        <button class="btn" id="btnClose">Kapat</button>
        <button class="btn primary" id="btnConfirm">Onayla & Gönder</button>
      </div>
    </div>
  </div>

<script>
  // ---------- Helpers ----------
  function $(id){ return document.getElementById(id); }

  const statusEl = $("status");
  function setStatus(type, text){
    statusEl.className = "status show " + (type || "");
    statusEl.textContent = text;
  }
  function clearStatus(){
    statusEl.className = "status";
    statusEl.textContent = "";
  }

  // Tek kaynaktan host + api
  function tenantHost(){ return window.TENANT_HOST; }
  function apiBase(){ return window.API_BASE; }

  async function apiSendPush(payload){
    const url = `${apiBase()}/admin/push/send?host=${encodeURIComponent(tenantHost())}`;

    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok || data?.ok === false) {
      throw new Error(data?.error || `HTTP_${res.status}`);
    }
    return data;
  }

  // ---------- Mode ----------
  let mode = "now"; // now | scheduled | test
  const chips = Array.from(document.querySelectorAll(".chip"));
  const scheduledWrap = $("scheduledWrap");

  function applyMode(newMode){
    mode = newMode;
    chips.forEach(c => c.classList.toggle("active", c.dataset.mode === newMode));
    scheduledWrap.style.display = (newMode === "scheduled") ? "block" : "none";
  }
  chips.forEach(ch => ch.addEventListener("click", () => applyMode(ch.dataset.mode)));

  // ---------- Counters ----------
  const titleEl = $("title");
  const msgEl = $("message");
  const cTitle = $("cTitle");
  const cMsg = $("cMsg");
  function syncCounts(){
    cTitle.textContent = (titleEl.value || "").length;
    cMsg.textContent = (msgEl.value || "").length;
  }
  titleEl.addEventListener("input", syncCounts);
  msgEl.addEventListener("input", syncCounts);
  syncCounts();

  // ---------- Modal ----------
  const modalBack = $("modalBack");
  const pvMode = $("pvMode");
  const pvTitle = $("pvTitle");
  const pvMessage = $("pvMessage");
  const pvTimeWrap = $("pvTimeWrap");
  const pvTime = $("pvTime");

  function openModal(){
    pvMode.textContent = (mode === "now") ? "Anında" : (mode === "scheduled" ? "Zamanlı" : "Test");
    pvTitle.textContent = (titleEl.value || "").trim() || "—";
    pvMessage.textContent = (msgEl.value || "").trim() || "—";

    if (mode === "scheduled"){
      const v = $("scheduledAt").value;
      pvTimeWrap.style.display = "block";
      pvTime.textContent = v ? v.replace("T"," ") : "—";
    } else {
      pvTimeWrap.style.display = "none";
    }

    modalBack.classList.add("show");
  }

  function closeModal(){
    modalBack.classList.remove("show");
  }

  $("btnPreview").addEventListener("click", () => {
    clearStatus();
    openModal();
  });

  $("btnClose").addEventListener("click", closeModal);
  modalBack.addEventListener("click", (e) => { if (e.target === modalBack) closeModal(); });

  // ---------- Send ----------
  function buildPayload(){
    const title = (titleEl.value || "").trim();
    const message = (msgEl.value || "").trim();
    if (!title || !message) throw new Error("Başlık ve mesaj zorunlu.");

    const payload = { title, message };

    if (mode === "scheduled"){
      const at = ($("scheduledAt").value || "").trim();
      if (!at) throw new Error("Zamanlı gönderim için tarih/saat seç.");
      payload.scheduled_at = at;
      payload.mode = "scheduled";
    } else if (mode === "test"){
      payload.mode = "test";
    } else {
      payload.mode = "now";
    }

    return payload;
  }

  async function doSend(){
    clearStatus();
    let payload;
    try {
      payload = buildPayload();
    } catch (e){
      setStatus("warn", e.message || "Eksik bilgi.");
      return;
    }

    setStatus("", "Gönderiliyor...");
    try {
      const out = await apiSendPush(payload);
      setStatus("ok", `Gönderildi ✅ sent=${out.sent} failed=${out.failed}`);
    } catch (e){
      setStatus("bad", `Hata ❌ ${e.message || e}`);
    }
  }

  $("btnSend").addEventListener("click", doSend);
  $("btnConfirm").addEventListener("click", async () => {
    closeModal();
    await doSend();
  });

  // Logout
  $("btnLogout").addEventListener("click", () => {
    try { localStorage.removeItem("betapp_admin_session"); } catch {}
    window.location.href = "index.html";
  });
</script>
</body>
</html>
